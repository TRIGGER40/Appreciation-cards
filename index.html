<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Open Graph -->
  <meta property="og:title" content="Appreciation Cards" />
  <meta property="og:description" content="Easily download a customised appreciation card for a peer who has been amazing lately!" />
  <meta property="og:image" content="https://res.cloudinary.com/dkb0gpqsk/image/upload/Appreciate_small_idmwun.png" />
  <meta property="og:url" content="https://trigger40.github.io/Certificate-Peer-Recognition/" />
  <meta property="og:type" content="website" />

  <title>Appreciation cards</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"
          integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA=="
          crossorigin="anonymous"></script>

  <style>
    /* General styling */
    body {
      font-family: sans-serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      background-image: url(https://res.cloudinary.com/dkb0gpqsk/image/upload/5669728_jzzjix.jpg);
      background-position: center;
      background-repeat: no-repeat;
      min-height: 100vh;
    }

    h1 {
      font-size: 36px;
      color: #000000;
      margin-top: 50px;
    }

    .description {
      margin: 0 auto 30px;
      font-size: 18px;
      color: #000000;
      max-width: 700px;
      line-height: 1.5;
    }

    /* Mobile step navigation */
    .mobile-step-nav {
      display: none;
      width: 100%;
      max-width: calc(100vw - 40px);
      margin: 20px auto;
      padding: 0;
    }

    .step-indicator {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 20px;
    }

    .step {
      display: flex;
      align-items: center;
      font-size: 14px;
      font-weight: bold;
      color: #666;
    }

    .step.active {
      color: #007bff;
    }

    .step-number {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: #ccc;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 10px;
    }

    .step.active .step-number {
      background: #007bff;
    }

    .step-divider {
      width: 40px;
      height: 2px;
      background: #ccc;
      margin: 0 10px;
    }

    /* Mobile content steps */
    .mobile-step {
      display: none;
      width: 100%;
      max-width: calc(100vw - 40px);
      padding: 0;
      margin: 0 auto;
    }

    .mobile-step.active {
      display: block;
    }

    /* Mobile form panel */
    .mobile-form-panel {
      width: 100%;
      max-width: calc(100vw - 40px);
      padding: 20px;
      background: #f9f9f9;
      border-radius: 10px;
      box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
      text-align: left;
      margin: 20px auto;
      box-sizing: border-box;
    }

    .mobile-form-panel label {
      font-weight: bold;
      font-size: 14px;
      margin-bottom: 8px;
    }

    .mobile-form-panel input,
    .mobile-form-panel select {
      display: block;
      width: 100%;
      box-sizing: border-box;
      padding: 10px;
      border-radius: 8px;
      font-size: 16px;
      outline: none;
      border: 1px solid #ccc;
      transition: border 0.2s ease-in-out;
      margin: 8px 0 40px 0;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      height: 44px;
      line-height: 24px;
    }

    .mobile-form-panel input:focus,
    .mobile-form-panel select:focus {
      border-color: #007bff;
      box-shadow: 0 0 5px rgba(0, 123, 255, 0.3);
    }
    
    .mobile-form-panel select {
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 10px center;
      background-size: 16px;
      padding-right: 40px;
    }

    .mobile-form-panel button {
      display: block;
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      font-size: 16px;
      background: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      transition: background 0.2s;
    }

    .mobile-form-panel button:hover {
      background: #0056b3;
    }

    /* Mobile preview panel */
    .mobile-preview-panel {
      width: 100%;
      max-width: calc(100vw - 40px);
      aspect-ratio: 2 / 1;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
      overflow: hidden;
      margin: 0 auto 20px auto;
      box-sizing: border-box;
    }

    .mobile-preview-panel #mobileCertImage {
      width: 100%;
      height: 100%;
      object-fit: cover;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 1;
    }

    .mobile-preview-panel .overlay {
      position: absolute;
      z-index: 3;
      color: #000;
    }

    .mobile-preview-panel #mobileCertName {
      width: 100%;
      top: 23%;
      left: 75%;
      transform: translateX(-50%);
      font-size: clamp(14px, 2.5vw, 26px);
      font-weight: bold;
      text-align: center;
    }

    .mobile-preview-panel #mobileCertFrom {
      bottom: 20%;
      left: 75%;
      transform: translateX(-50%);
      width: 100%;
      font-size: clamp(10px, 1.8vw, 12px);
      text-align: center;
      padding: 0 10px;
    }

    .mobile-preview-panel #mobileCertDate {
      bottom: 10%;
      left: 75%;
      transform: translateX(-50%);
      width: 35%;
      font-size: clamp(10px, 1.8vw, 12px);
      text-align: center;
    }

    /* Mobile action buttons */
    .mobile-actions {
      display: flex;
      gap: 10px;
      margin: 20px auto 0 auto;
      width: 100%;
      max-width: calc(100vw - 40px);
      box-sizing: border-box;
    }

    .mobile-actions button {
      flex: 1;
      padding: 12px;
      border-radius: 8px;
      font-size: 16px;
      border: none;
      cursor: pointer;
      transition: background 0.2s;
    }

    .mobile-actions .back-btn {
      background: #6c757d;
      color: white;
    }

    .mobile-actions .back-btn:hover {
      background: #545b62;
    }

    .mobile-actions .download-btn {
      background: #007bff;
      color: white;
    }

    .mobile-actions .download-btn:hover {
      background: #0056b3;
    }

    /* Mobile warning - hide on mobile */
    .mobile-warning {
      display: none;
    }

    /* Layout */
    .container {
      display: flex;
      gap: 20px;
      padding: 20px;
      flex-wrap: wrap;
      justify-content: center;
    }

    /* Form panel */
    .form-panel {
      width: 320px;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 10px;
      box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
      display: flex;
      text-align: left;
      flex-direction: column;
    }

    .form-panel label {
      font-weight: bold;
      font-size: 14px;
      margin-bottom: 8px; /* gap between label and its input */
    }

    .form-panel input,
    .form-panel select {
      display: block;
      width: 100%;
      box-sizing: border-box;
      padding: 10px;
      border-radius: 8px;
      font-size: 14px;
      outline: none;
      border: 1px solid #ccc;
      transition: border 0.2s ease-in-out;
      margin-bottom: 40px; /* gap between input sections */
    }

    .form-panel input:focus,
    .form-panel select:focus {
      border-color: #007bff;
      box-shadow: 0 0 5px rgba(0, 123, 255, 0.3);
    }

    .form-panel button {
      display: block;
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      font-size: 16px;
      background: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      transition: background 0.2s;
    }

    .form-panel button:hover {
      background: #0056b3;
    }

    /* Preview panel */
    .preview-panel {
      width: 800px;
      height: 400px;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
      overflow: hidden;
    }

    #certImage {
      width: 100%;
      height: 100%;
      object-fit: cover;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 1;
    }

    .overlay {
      position: absolute;
      z-index: 3;
      color: #000;
    }

    #certName {
      width: 320px;
      top: 100px;
      left: 435px;
      font-size: 26px;
      font-weight: bold;
      text-align: center;
    }

    #certFrom {
      bottom: 45px;
      left: 420px;
      width: 320px;
      font-size: 12px;
      text-align: center;
      padding: 0 15px;
    }

    #certDate {
      bottom: 25px;
      left: 440px;
      width: 320px;
      font-size: 12px;
      text-align: center;
    }

    footer p {
      margin-top: 30px;
      padding: 20px;
      text-align: center;
      color: #000000;
      font-size: 14px;
    }

    /* Mobile responsive styles */
    @media only screen and (max-width: 768px) {
      .mobile-step-nav {
        display: block;
      }
      
      .mobile-step {
        display: none;
      }
      
      .mobile-step.active {
        display: block;
      }
      
      .main-content {
        display: none;
      }
      
      .mobile-header {
        display: block !important;
        width: 100%;
        text-align: center;
        padding: 20px;
      }
      
      .mobile-warning {
        display: none !important;
      }
      
      h1 {
        font-size: 28px;
        margin-top: 30px;
      }
      
      .description {
        font-size: 16px;
        margin: 0 auto 20px;
        padding: 0 20px;
      }
      
      /* Ensure mobile preview fits properly */
      .mobile-preview-panel {
        width: calc(100vw - 40px);
        max-width: calc(100vw - 40px);
        aspect-ratio: 2 / 1;
      }
      
      /* Adjust text positioning for better mobile fit */
      .mobile-preview-panel #mobileCertName {
        width: 100%;
        top: 23%;
        left: 75%;
        transform: translateX(-50%);
        font-size: clamp(14px, 2.5vw, 26px);
      }
      
      .mobile-preview-panel #mobileCertFrom {
        bottom: 20%;
        left: 75%;
        transform: translateX(-50%);
        width: 100%;
        font-size: clamp(10px, 1.8vw, 12px);
      }
      
      .mobile-preview-panel #mobileCertDate {
        bottom: 10%;
        left: 75%;
        transform: translateX(-50%);
        width: 100%;
        font-size: clamp(10px, 1.8vw, 12px);
      }
    }

    /* Mobile header - hidden by default */
    .mobile-header {
      display: none;
      width: 100%;
      text-align: center;
      padding: 20px;
    }

    /* Ensure mobile elements are hidden on desktop */
    @media only screen and (min-width: 769px) {
      .mobile-step-nav,
      .mobile-step,
      .mobile-header {
        display: none !important;
      }
      
      .main-content {
        display: block !important;
      }
    }
  </style>
</head>
<body>

  <div class="mobile-warning">
    <h2>We're working on it!</h2>
    <p>This page is not yet optimized for mobile devices.<br>
    For the best experience, please access it from a desktop.<br>
    Thanks for your patience!</p>
  </div>

  <!-- Mobile Header -->
  <div class="mobile-header">
    <h1>Appreciation cards</h1>
    <p class="description">
      Thank you for taking time out to appreciate your peers. Fill in the required details, download the card and share it in Mail or Slack.
    </p>
  </div>

  <div class="main-content">
    <h1>Appreciation cards</h1>
    <p class="description">
      Thank you for taking time out to appreciate your peers. Fill in the required details, download the card and share it in Mail or Slack.
    </p>

    <div class="container">
      <!-- Left Panel -->
      <div class="form-panel">
        <label for="awardeeName">Awardee name:</label>
        <input type="text" id="awardeeName" placeholder="Enter recipient name" />

        <label for="awardType">Select appreciation card:</label>
        <select id="awardType">
          <option value="Lifeguard">The Lifeguard</option>
          <option value="Monk">The Monk</option>
          <option value="Spark">The Spark</option>
          <option value="Knight">The Knight</option>
          <option value="Funone">The Fun One</option>
        </select>

        <label for="fromName">Your name:</label>
        <input type="text" id="fromName" placeholder="Your name" />

        <button id="downloadBtn">Download appreciation card</button>
      </div>

      <!-- Right Panel -->
      <div id="previewPanel" class="preview-panel">
        <img id="certImage" crossorigin="anonymous" src="" alt="Certificate Background" />
        <div class="overlay" id="certName">Awardee Name</div>
        <div class="overlay" id="certFrom">Given by: Your Name</div>
        <div class="overlay" id="certDate"></div>
      </div>
    </div>
  </div>

  <!-- Mobile Step Navigation -->
  <div class="mobile-step-nav">
    <div class="step-indicator">
      <div class="step active" id="step1-indicator">
        <div class="step-number">1</div>
        <span>Details</span>
      </div>
      <div class="step-divider"></div>
      <div class="step" id="step2-indicator">
        <div class="step-number">2</div>
        <span>Preview</span>
      </div>
    </div>
  </div>

  <!-- Mobile Step 1: Form -->
  <div class="mobile-step active" id="mobile-step1">
    <div class="mobile-form-panel">
      <label for="mobileAwardeeName">Awardee name:</label>
      <input type="text" id="mobileAwardeeName" placeholder="Enter recipient name" />

      <label for="mobileAwardType">Select appreciation card:</label>
      <select id="mobileAwardType">
        <option value="Lifeguard">The Lifeguard</option>
        <option value="Monk">The Monk</option>
        <option value="Spark">The Spark</option>
        <option value="Knight">The Knight</option>
        <option value="Funone">The Fun One</option>
      </select>

      <label for="mobileFromName">Your name:</label>
      <input type="text" id="mobileFromName" placeholder="Your name" />

      <button id="mobilePreviewBtn">Preview appreciation card</button>
    </div>
  </div>

  <!-- Mobile Step 2: Preview -->
  <div class="mobile-step" id="mobile-step2">
    <div class="mobile-preview-panel" id="mobilePreviewPanel">
      <img id="mobileCertImage" crossorigin="anonymous" src="" alt="Certificate Background" />
      <div class="overlay" id="mobileCertName">Awardee Name</div>
      <div class="overlay" id="mobileCertFrom">Given by: Your Name</div>
      <div class="overlay" id="mobileCertDate"></div>
    </div>
    
    <div class="mobile-actions">
      <button class="back-btn" id="mobileBackBtn">Go back</button>
      <button class="download-btn" id="mobileDownloadBtn">Download card</button>
    </div>
  </div>

  <footer>
    <p>Built by Adobe Design with ❤️</p>
  </footer>

  <script>
    // Desktop elements
    const awardeeNameInput = document.getElementById("awardeeName");
    const awardTypeSelect = document.getElementById("awardType");
    const fromNameInput = document.getElementById("fromName");
    const downloadBtn = document.getElementById("downloadBtn");

    const certImage = document.getElementById("certImage");
    const certName = document.getElementById("certName");
    const certFrom = document.getElementById("certFrom");
    const certDate = document.getElementById("certDate");

    // Mobile elements
    const mobileAwardeeNameInput = document.getElementById("mobileAwardeeName");
    const mobileAwardTypeSelect = document.getElementById("mobileAwardType");
    const mobileFromNameInput = document.getElementById("mobileFromName");
    const mobilePreviewBtn = document.getElementById("mobilePreviewBtn");
    const mobileBackBtn = document.getElementById("mobileBackBtn");
    const mobileDownloadBtn = document.getElementById("mobileDownloadBtn");

    const mobileCertImage = document.getElementById("mobileCertImage");
    const mobileCertName = document.getElementById("mobileCertName");
    const mobileCertFrom = document.getElementById("mobileCertFrom");
    const mobileCertDate = document.getElementById("mobileCertDate");

    const step1Indicator = document.getElementById("step1-indicator");
    const step2Indicator = document.getElementById("step2-indicator");
    const mobileStep1 = document.getElementById("mobile-step1");
    const mobileStep2 = document.getElementById("mobile-step2");

    const certificateImages = {
      Lifeguard: "https://res.cloudinary.com/dkb0gpqsk/image/upload/Lifeguard_thrs9n.png",
      Monk: "https://res.cloudinary.com/dkb0gpqsk/image/upload/Monk_vkljbv.png",
      Knight: "https://res.cloudinary.com/dkb0gpqsk/image/upload/Knight_ghejyd.png",
      Spark: "https://res.cloudinary.com/dkb0gpqsk/image/upload/Spark_stmhq8.png",
      Funone: "https://res.cloudinary.com/dkb0gpqsk/image/upload/Funone_suy5sk.png",
    };

    // Set today's date
    const today = new Date();
    const dateString = today.toLocaleDateString("en-GB", {
      day: "2-digit",
      month: "short",
      year: "numeric",
    });
    
    certDate.innerText = dateString;
    mobileCertDate.innerText = dateString;

    function updateDesktopPreview() {
      certName.innerText = awardeeNameInput.value || "Awardee Name";
      certFrom.innerText = fromNameInput.value ? `Given by: ${fromNameInput.value}` : "Given by: Your Name";

      const selectedAward = awardTypeSelect.value;
      certImage.src = certificateImages[selectedAward] || "";
    }

    function updateMobilePreview() {
      mobileCertName.innerText = mobileAwardeeNameInput.value || "Awardee Name";
      mobileCertFrom.innerText = mobileFromNameInput.value ? `Given by: ${mobileFromNameInput.value}` : "Given by: Your Name";

      const selectedAward = mobileAwardTypeSelect.value;
      mobileCertImage.src = certificateImages[selectedAward] || "";
    }

    function goToStep2() {
      mobileStep1.classList.remove("active");
      mobileStep2.classList.add("active");
      step1Indicator.classList.remove("active");
      step2Indicator.classList.add("active");
      updateMobilePreview();
    }

    function goToStep1() {
      mobileStep2.classList.remove("active");
      mobileStep1.classList.add("active");
      step2Indicator.classList.remove("active");
      step1Indicator.classList.add("active");
    }

    function downloadCard(previewElement, fileName, isMobile = false) {
      const scale = isMobile ? 2 : 2; // Both mobile and desktop use 2x scale for high quality
      
      // For mobile downloads, temporarily set the preview panel to full desktop size
      let originalWidth, originalHeight, originalMaxWidth, originalAspectRatio;
      let originalNameFontSize, originalFromFontSize, originalDateFontSize;
      
      if (isMobile) {
        const mobilePreviewPanel = document.getElementById("mobilePreviewPanel");
        const mobileCertName = document.getElementById("mobileCertName");
        const mobileCertFrom = document.getElementById("mobileCertFrom");
        const mobileCertDate = document.getElementById("mobileCertDate");
        
        // Store original styles
        originalWidth = mobilePreviewPanel.style.width;
        originalHeight = mobilePreviewPanel.style.height;
        originalMaxWidth = mobilePreviewPanel.style.maxWidth;
        originalAspectRatio = mobilePreviewPanel.style.aspectRatio;
        originalNameFontSize = mobileCertName.style.fontSize;
        originalFromFontSize = mobileCertFrom.style.fontSize;
        originalDateFontSize = mobileCertDate.style.fontSize;
        
        // Set to desktop size for high-quality capture
        mobilePreviewPanel.style.width = '800px';
        mobilePreviewPanel.style.height = '400px';
        mobilePreviewPanel.style.maxWidth = '800px';
        mobilePreviewPanel.style.aspectRatio = 'none';
        
        // Scale up fonts to match desktop proportions
        mobileCertName.style.fontSize = '26px';
        mobileCertFrom.style.fontSize = '12px';
        mobileCertDate.style.fontSize = '12px';
      }
      
      // Detect Android and use appropriate settings
      const isAndroid = /Android/i.test(navigator.userAgent);
      console.log('Is Android:', isAndroid);
      
      // Try with minimal html2canvas options - keep CORS enabled for images
      html2canvas(previewElement, {
        scale: 1,
        useCORS: true,
        allowTaint: true,
        backgroundColor: '#ffffff',
        logging: isAndroid ? true : false
      })
        .then(canvas => {
          // Restore original mobile styling
          if (isMobile) {
            const mobilePreviewPanel = document.getElementById("mobilePreviewPanel");
            const mobileCertName = document.getElementById("mobileCertName");
            const mobileCertFrom = document.getElementById("mobileCertFrom");
            const mobileCertDate = document.getElementById("mobileCertDate");
            
            mobilePreviewPanel.style.width = originalWidth;
            mobilePreviewPanel.style.height = originalHeight;
            mobilePreviewPanel.style.maxWidth = originalMaxWidth;
            mobilePreviewPanel.style.aspectRatio = originalAspectRatio;
            mobileCertName.style.fontSize = originalNameFontSize;
            mobileCertFrom.style.fontSize = originalFromFontSize;
            mobileCertDate.style.fontSize = originalDateFontSize;
          }
          
                                                 const link = document.createElement('a');
             link.download = fileName;
             link.href = canvas.toDataURL('image/png', 1.0);
             
             // Android-specific download handling
             if (isAndroid) {
               console.log('Android detected, opening certificate image in new tab');
               // Android: Open high-quality certificate image in new tab
               const dataUrl = canvas.toDataURL('image/png', 1.0);
               const newWindow = window.open('', '_blank');
               newWindow.document.write(`
                 <!DOCTYPE html>
                 <html>
                 <head>
                   <title>Appreciation Card</title>
                   <meta name="viewport" content="width=device-width, initial-scale=1.0">
                   <style>
                     body { margin: 0; padding: 20px; background: white; text-align: center; }
                     img { max-width: 100%; height: auto; border: 1px solid #ccc; }
                   </style>
                 </head>
                 <body>
                   <img src="${dataUrl}" alt="Appreciation Card" />
                 </body>
                 </html>
               `);
               newWindow.document.close();
             } else {
               link.click();
             }

          // Save to Google Sheets after successful download
          setTimeout(() => {
            const awardeeName = isMobile ? mobileAwardeeNameInput.value : awardeeNameInput.value || "N/A";
            const awardType = isMobile ? mobileAwardTypeSelect.value : awardTypeSelect.value || "N/A";
            const fromName = isMobile ? mobileFromNameInput.value : fromNameInput.value || "N/A";
            const currentDate = new Date().toLocaleString();
            
            // Create a hidden iframe for form submission
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.name = 'google-sheets-iframe';
            document.body.appendChild(iframe);
            
            // Create a hidden form and submit it to the iframe
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = 'https://script.google.com/macros/s/AKfycbwv-s7nlQLyNUJVz61o7mZAaNyRX3KeaSctom7vgSlpokxPtwZ70vQNAetF6Q8JizUv9A/exec';
            form.target = 'google-sheets-iframe';
            form.style.display = 'none';
            
            // Add form fields
            const fields = [
              { name: 'awardeeName', value: awardeeName },
              { name: 'awardType', value: awardType },
              { name: 'fromName', value: fromName },
              { name: 'date', value: currentDate }
            ];
            
            fields.forEach(field => {
              const input = document.createElement('input');
              input.type = 'hidden';
              input.name = field.name;
              input.value = field.value;
              form.appendChild(input);
            });
            
            // Submit the form to the iframe
            document.body.appendChild(form);
            form.submit();
            
            // Clean up after a short delay
            setTimeout(() => {
              if (document.body.contains(form)) document.body.removeChild(form);
              if (document.body.contains(iframe)) document.body.removeChild(iframe);
            }, 1000);
            
            console.log("Excel data submitted via iframe form");
          }, 500); // Delay sheets update to ensure download completes first
        })
        .catch(error => {
          console.error("First attempt failed:", error);
          
          // Fallback: try with even simpler options but keep CORS for images
          html2canvas(previewElement, {
            scale: 1,
            useCORS: true,
            allowTaint: true,
            backgroundColor: '#ffffff',
            width: isAndroid ? 800 : undefined,
            height: isAndroid ? 400 : undefined
          })
          .then(canvas => {
            // Restore original mobile styling
            if (isMobile) {
              const mobilePreviewPanel = document.getElementById("mobilePreviewPanel");
              const mobileCertName = document.getElementById("mobileCertName");
              const mobileCertFrom = document.getElementById("mobileCertFrom");
              const mobileCertDate = document.getElementById("mobileCertDate");
              
              mobilePreviewPanel.style.width = originalWidth;
              mobilePreviewPanel.style.height = originalHeight;
              mobilePreviewPanel.style.maxWidth = originalMaxWidth;
              mobilePreviewPanel.style.aspectRatio = originalAspectRatio;
              mobileCertName.style.fontSize = originalNameFontSize;
              mobileCertFrom.style.fontSize = originalFromFontSize;
              mobileCertDate.style.fontSize = originalDateFontSize;
            }
            
            const link = document.createElement('a');
            link.download = fileName;
            link.href = canvas.toDataURL('image/png', 1.0);
            
            // Android-specific download handling for fallback
            if (isAndroid) {
              console.log('Android detected, using enhanced download method');
              try {
                // Method 1: Try blob with explicit user interaction
                canvas.toBlob(function(blob) {
                  const url = URL.createObjectURL(blob);
                  const link = document.createElement('a');
                  link.href = url;
                  link.download = fileName;
                  link.style.display = 'none';
                  document.body.appendChild(link);
                  
                  // Trigger click with user interaction context
                  setTimeout(() => {
                    link.click();
                    setTimeout(() => {
                      document.body.removeChild(link);
                      URL.revokeObjectURL(url);
                    }, 100);
                  }, 50);
                }, 'image/png', 1.0);
              } catch (e) {
                console.log('Android blob method failed, trying direct download');
                // Method 2: Direct download as fallback
                try {
                  link.click();
                } catch (directError) {
                  console.log('Direct download also failed, trying user prompt');
                  // Method 3: User prompt as last resort
                  const dataUrl = canvas.toDataURL('image/png', 1.0);
                  if (confirm('Download failed automatically. Would you like to open the image in a new tab to save it manually?')) {
                    const newWindow = window.open();
                    newWindow.document.write('<img src="' + dataUrl + '" style="max-width:100%;height:auto;" />');
                    newWindow.document.title = fileName;
                  }
                }
              }
            } else {
              link.click();
            }

            // Save to Google Sheets after successful download
            setTimeout(() => {
              const awardeeName = isMobile ? mobileAwardeeNameInput.value : awardeeNameInput.value || "N/A";
              const awardType = isMobile ? mobileAwardTypeSelect.value : awardTypeSelect.value || "N/A";
              const fromName = isMobile ? mobileFromNameInput.value : fromNameInput.value || "N/A";
              const currentDate = new Date().toLocaleString();
              
              // Create a hidden iframe for form submission
              const iframe = document.createElement('iframe');
              iframe.style.display = 'none';
              iframe.name = 'google-sheets-iframe';
              document.body.appendChild(iframe);
              
              // Create a hidden form and submit it to the iframe
              const form = document.createElement('form');
              form.method = 'POST';
              form.action = 'https://script.google.com/macros/s/AKfycbwv-s7nlQLyNUJVz61o7mZAaNyRX3KeaSctom7vgSlpokxPtwZ70vQNAetF6Q8JizUv9A/exec';
              form.target = 'google-sheets-iframe';
              form.style.display = 'none';
              
              // Add form fields
              const fields = [
                { name: 'awardeeName', value: awardeeName },
                { name: 'awardType', value: awardType },
                { name: 'fromName', value: fromName },
                { name: 'date', value: currentDate }
              ];
              
              fields.forEach(field => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = field.name;
                input.value = field.value;
                form.appendChild(input);
              });
              
              // Submit the form to the iframe
              document.body.appendChild(form);
              form.submit();
              
              // Clean up after a short delay
              setTimeout(() => {
                if (document.body.contains(form)) document.body.removeChild(form);
                if (document.body.contains(iframe)) document.body.removeChild(iframe);
              }, 1000);
              
              console.log("Excel data submitted via iframe form (fallback)");
            }, 500);
          })
          .catch(fallbackError => {
            console.error("Fallback also failed:", fallbackError);
            alert("There was an error generating your certificate. Please try again.");
          });
        });
    }

    // Desktop event listeners
    awardeeNameInput.addEventListener("input", updateDesktopPreview);
    fromNameInput.addEventListener("input", updateDesktopPreview);
    awardTypeSelect.addEventListener("change", updateDesktopPreview);

    downloadBtn.addEventListener("click", () => {
      downloadCard(document.getElementById("previewPanel"), 'Thankyou.png', false);
    });

    // Mobile event listeners
    mobileAwardeeNameInput.addEventListener("input", updateMobilePreview);
    mobileFromNameInput.addEventListener("input", updateMobilePreview);
    mobileAwardTypeSelect.addEventListener("change", updateMobilePreview);

    mobilePreviewBtn.addEventListener("click", goToStep2);
    mobileBackBtn.addEventListener("click", goToStep1);
    mobileDownloadBtn.addEventListener("click", () => {
      // For Android, ensure download happens within user interaction context
      const isAndroid = /Android/i.test(navigator.userAgent);
      if (isAndroid) {
        console.log('Android download button clicked');
        // Small delay to ensure user interaction context is maintained
        setTimeout(() => {
          downloadCard(document.getElementById("mobilePreviewPanel"), 'Thankyou.png', true);
        }, 10);
      } else {
        downloadCard(document.getElementById("mobilePreviewPanel"), 'Thankyou.png', true);
      }
    });
    
    // Change button text for Android
    const isAndroid = /Android/i.test(navigator.userAgent);
    if (isAndroid) {
      mobileDownloadBtn.textContent = "Open card in a new tab";
    }

    // Initialize previews on load
    updateDesktopPreview();
    updateMobilePreview();
  </script>
</body>
</html>
